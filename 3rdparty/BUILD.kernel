load("@bazel_skylib//rules:copy_file.bzl", "copy_file")
load("@kleaf//common/kleaf:kernel.bzl", "kernel_build")

package(default_visibility = ["//visibility:public"])

copy_file(
    name = "build_config_aarch64",
    src = "@kernel_toolchain_aarch64//:build.config",
    out = "build.config.aarch64",
)

copy_file(
    name = "build_config_x86_64",
    src = "@kernel_toolchain_x86_64//:build.config",
    out = "build.config.x86_64",
)

copy_file(
    name = "kernel_config_aarch64",
    src = "@kernel-build-example//3rdparty:kernel.config.aarch64",
    out = "kernel.config.aarch64",
)

copy_file(
    name = "kernel_config_x86_64",
    src = "@kernel-build-example//3rdparty:kernel.config.x86_64",
    out = "kernel.config.x86_64",
)

kernel_build(
    name = "kernel_aarch64",
    srcs = glob(
        ["**"],
        exclude = [
            "android/*",
            "BUILD.bazel",
            "**/*.bzl",
            ".git/**",
        ],
    ) + [
        "build.config.aarch64",
        "kernel.config.aarch64",
    ],
    outs = [
        "System.map",
        "modules.builtin",
        "vmlinux",
    ],
    build_config = "build.config.aarch64",
    kernel_config = "kernel.config.aarch64",
    kernel_dir = "external/linux",
    skip_defconfig = True,
)

kernel_build(
    name = "kernel_x86_64",
    srcs = glob(
        ["**"],
        exclude = [
            "android/*",
            "BUILD.bazel",
            "**/*.bzl",
            ".git/**",
        ],
    ) + [
        "build.config.x86_64",
        "kernel.config.x86_64",
    ],
    outs = [
        "System.map",
        "arch/x86/boot/bzImage",
        "modules.builtin",
        "vmlinux",
    ],
    build_config = "build.config.x86_64",
    kernel_config = "kernel.config.x86_64",
    kernel_dir = "external/linux",
    skip_defconfig = True,
)
